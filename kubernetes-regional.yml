include:
  - remote: 'https://raw.githubusercontent.com/gadiener/ci-templates/v1.0.1/kubernetes-quality.yml'

deploy:production:image:
  extends: .deploy:production:image
  variables:
    GOOGLE_KEY: ${GOOGLE_KEY_PRODUCTION}
    CLUSTER_NAME: ${CLUSTER_NAME_PRODUCTION}
    CLUSTER_ZONE: ${CLUSTER_ZONE_PRODUCTION}
    DOMAIN: ${DOMAIN_PRODUCTION}
    SECRET_YAML: ${SECRET_YAML_PRODUCTION}
    NAMESPACE: ${NAMESPACE_PRODUCTION}
    ENVIRONMENT: production
    ENVIRONMENT_NAME: production
  before_script:
    - |
      # CHECK VARIABLES PHASE
      for var in "GOOGLE_KEY_PRODUCTION" "CLUSTER_NAME_PRODUCTION" "CLUSTER_ZONE_PRODUCTION"; do
          if [ -z "${!var}" ]; then
            echo "Missing '${var}' variable!"
            exit 1
          fi
      done

deploy:production:manifest:
  extends: .deploy:production:manifest
  variables:
    GOOGLE_KEY: ${GOOGLE_KEY_PRODUCTION}
    CLUSTER_NAME: ${CLUSTER_NAME_PRODUCTION}
    CLUSTER_ZONE: ${CLUSTER_ZONE_PRODUCTION}
    DOMAIN: ${DOMAIN_PRODUCTION}
    SECRET_YAML: ${SECRET_YAML_PRODUCTION}
    NAMESPACE: ${NAMESPACE_PRODUCTION}
    ENVIRONMENT: production
    ENVIRONMENT_NAME: production
  before_script:
    - |
      # CHECK VARIABLES PHASE
      for var in "GOOGLE_KEY_PRODUCTION" "CLUSTER_NAME_PRODUCTION" "CLUSTER_ZONE_PRODUCTION"; do
          if [ -z "${!var}" ]; then
            echo "Missing '${var}' variable!"
            exit 1
          fi
      done
  when: manual

rollback:production:
  extends: .rollback
  stage: rollback
  variables:
    GOOGLE_KEY: ${GOOGLE_KEY_PRODUCTION}
    CLUSTER_NAME: ${CLUSTER_NAME_PRODUCTION}
    CLUSTER_ZONE: ${CLUSTER_ZONE_PRODUCTION}
    NAMESPACE: ${NAMESPACE_PRODUCTION}
  before_script:
    - |
      # CHECK VARIABLES PHASE
      for var in "GOOGLE_KEY_PRODUCTION" "CLUSTER_NAME_PRODUCTION" "CLUSTER_ZONE_PRODUCTION"; do
          if [ -z "${!var}" ]; then
            echo "Missing '${var}' variable!"
            exit 1
          fi
      done
  when: on_failure
  only:
    - /^v.+$/i
  except:
    - branches